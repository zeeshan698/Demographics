pipeline {
    agent any

    stages {
        
        stage('SCM') {
            steps{
               git url: 'https://github.com/vicky-devops/Demographics.git'

            }
        }
        
        stage('Unit Testing') {
            steps {
                 sh """
                 python3.8 -m pip install --user --upgrade pip
                 python3.8 -m pip install pytest mock codecov pydocstyle pytest-cov pylint pylint_junit
                 python3.8 -m pip install --user -r requirements.txt
                 python3.8 -m pytest -v test/ --doctest-modules --junitxml=unit-testresults.xml --cov=python/ --cov-append --cov-report=xml:coverage.xml --cov-report=html:htmlcov
                 """
            }
        }
        stage('Dependencies & ML train - Deploy') {
            steps {
                    withEnv(["HOME=${env.WORKSPACE}"]) {
                       sh"""
                       python3.8 -m pip install --user --upgrade pip
                       python3.8 -m pip install --user -r requirements.txt 
                       python3.8 ./python/drug_demographics.py
                       """
                    } 
            }
        }
   }     
   post {
        always {
            junit '**/*-testresults.xml'
            
            step([$class: 'CoberturaPublisher', autoUpdateHealth: false, autoUpdateStability: false, coberturaReportFile: '**/coverage.xml', failUnhealthy: false, failUnstable:              false, maxNumberOfBuilds: 0, onlyStable: false, sourceEncoding: 'ASCII', zoomCoverageChart: false])
            cleanWs()

        }
    }
    
}
